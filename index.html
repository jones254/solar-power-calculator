<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Football Match Predictor</title>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #f8f9fa;
            --border-color: #dee2e6;
            --text-color: #333;
            --light-text: #6c757d;
            --background-color: #f0f2f5;
            --card-bg: #ffffff;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .container {
            max-width: 800px;
            width: 100%;
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 20px;
        }

        header h1 {
            color: var(--primary-color);
            font-size: 28px;
            margin: 0;
        }

        .input-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 20px;
        }

        .team-box, .odds-box {
            background-color: var(--secondary-color);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .odds-box {
            grid-column: 1 / -1;
        }
        
        .team-box h2, .odds-box h2 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 20px;
            text-align: center;
            color: var(--text-color);
        }

        .form-group {
            margin-bottom: 12px;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 5px;
            font-size: 14px;
            color: var(--light-text);
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 16px;
        }

        #predictBtn {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            font-weight: bold;
            color: #fff;
            background-color: var(--primary-color);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #predictBtn:hover {
            background-color: #0056b3;
        }

        #results-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        .result-card {
            background: var(--secondary-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .result-card h3 {
            margin-top: 0;
            text-align: center;
            color: var(--primary-color);
        }
        
        #wagering-advice {
            font-size: 22px;
            font-weight: bold;
            text-align: center;
            padding: 15px;
            border-radius: 5px;
        }
        
        .advice-pass {
            background-color: #ffc107;
            color: #333;
        }

        .advice-bet {
            background-color: #28a745;
            color: white;
        }
        
        .probabilities-grid, .stats-grid {
            display: grid;
            gap: 15px;
            text-align: center;
        }
        
        .probabilities-grid { grid-template-columns: repeat(3, 1fr); }
        .stats-grid { grid-template-columns: repeat(2, 1fr); }
        
        .prob-item, .stat-item {
            padding: 10px;
        }
        
        .prob-item .label, .stat-item .label {
            font-size: 14px;
            color: var(--light-text);
        }
        
        .prob-item .value, .stat-item .value {
            font-size: 24px;
            font-weight: bold;
        }
        
        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }
        .breakdown-item:last-child {
            border-bottom: none;
        }
        
        .breakdown-item .model-name {
            font-weight: 500;
        }
        
        .breakdown-item .model-probs {
            font-family: monospace;
            font-size: 14px;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 600px) {
            .input-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>âš½ Football Match Predictor</h1>
        </header>

        <div class="input-grid">
            <div class="team-box">
                <h2>Home Team</h2>
                <div class="form-group">
                    <label for="home_avg_score">Average Scored</label>
                    <input type="number" id="home_avg_score" step="0.01" value="1.6">
                </div>
                <div class="form-group">
                    <label for="home_avg_conceded">Average Conceded</label>
                    <input type="number" id="home_avg_conceded" step="0.01" value="0.7">
                </div>
                <div class="form-group">
                    <label for="home_score_percentage">Scoring Percentage (%)</label>
                    <input type="number" id="home_score_percentage" step="1" value="75">
                </div>
                <div class="form-group">
                    <label for="home_cleansheet">Clean Sheet (%)</label>
                    <input type="number" id="home_cleansheet" step="1" value="50">
                </div>
                <div class="form-group">
                    <label for="home_difficulty">Difficulty (1-5)</label>
                    <input type="number" id="home_difficulty" step="1" min="1" max="5" value="2">
                </div>
            </div>

            <div class="team-box">
                <h2>Away Team</h2>
                <div class="form-group">
                    <label for="away_avg_score">Average Scored</label>
                    <input type="number" id="away_avg_score" step="0.01" value="1.16">
                </div>
                <div class="form-group">
                    <label for="away_avg_conceded">Average Conceded</label>
                    <input type="number" id="away_avg_conceded" step="0.01" value="1.37">
                </div>
                <div class="form-group">
                    <label for="away_score_percentage">Scoring Percentage (%)</label>
                    <input type="number" id="away_score_percentage" step="1" value="74">
                </div>
                <div class="form-group">
                    <label for="away_cleansheet">Clean Sheet (%)</label>
                    <input type="number" id="away_cleansheet" step="1" value="21">
                </div>
                <div class="form-group">
                    <label for="away_difficulty">Difficulty (1-5)</label>
                    <input type="number" id="away_difficulty" step="1" min="1" max="5" value="3">
                </div>
            </div>
            
            <div class="odds-box">
                <h2>Match Odds</h2>
                 <div class="probabilities-grid">
                    <div class="form-group">
                        <label for="home_odds">Home Win Odds</label>
                        <input type="number" id="home_odds" step="0.01" value="1.75">
                    </div>
                    <div class="form-group">
                        <label for="draw_odds">Draw Odds</label>
                        <input type="number" id="draw_odds" step="0.01" value="3.50">
                    </div>
                    <div class="form-group">
                        <label for="away_odds">Away Win Odds</label>
                        <input type="number" id="away_odds" step="0.01" value="5.00">
                    </div>
                </div>
            </div>
        </div>

        <button id="predictBtn">ðŸ”® Predict Match</button>

        <div id="results-section" class="hidden">
            <div class="result-card">
                 <h3>Wagering Advice</h3>
                 <div id="wagering-advice">PASS</div>
            </div>
            
            <div class="result-card">
                <h3>ðŸ“Š Prediction Analysis</h3>
                <p style="text-align:center; color: var(--light-text);">Predicted Outcome: <strong id="predicted-outcome">Home Win</strong> with <strong id="confidence-level">0.0%</strong> confidence.</p>

                <h4>Final Probabilities:</h4>
                <div class="probabilities-grid">
                    <div class="prob-item">
                        <div class="label">Home Win</div>
                        <div class="value" id="final-prob-home">0.0%</div>
                    </div>
                    <div class="prob-item">
                        <div class="label">Draw</div>
                        <div class="value" id="final-prob-draw">0.0%</div>
                    </div>
                    <div class="prob-item">
                        <div class="label">Away Win</div>
                        <div class="value" id="final-prob-away">0.0%</div>
                    </div>
                </div>

                <h4 style="margin-top: 25px;">Expected Goals:</h4>
                 <div class="stats-grid">
                     <div class="stat-item">
                         <div class="label">Home Team</div>
                         <div class="value" id="expected-goals-home">0.00</div>
                     </div>
                     <div class="stat-item">
                         <div class="label">Away Team</div>
                         <div class="value" id="expected-goals-away">0.00</div>
                     </div>
                 </div>

                <h4 style="margin-top: 25px;">Team Quality Scores:</h4>
                 <div class="stats-grid">
                     <div class="stat-item">
                         <div class="label">Home Team</div>
                         <div class="value" id="quality-score-home">0.00</div>
                     </div>
                     <div class="stat-item">
                         <div class="label">Away Team</div>
                         <div class="value" id="quality-score-away">0.00</div>
                     </div>
                 </div>

                <h4 style="margin-top: 25px;">Model Breakdown:</h4>
                <div class="breakdown-grid">
                    <div id="breakdown-poisson" class="breakdown-item"></div>
                    <div id="breakdown-form_based" class="breakdown-item"></div>
                    <div id="breakdown-defensive_strength" class="breakdown-item"></div>
                    <div id="breakdown-market_sentiment" class="breakdown-item"></div>
                    <div id="breakdown-composite_rating" class="breakdown-item"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class FootballPredictor {
            constructor() {
                this.weights = {
                    'poisson': 0.25,
                    'form_based': 0.20,
                    'defensive_strength': 0.15,
                    'market_sentiment': 0.20,
                    'composite_rating': 0.20
                };
                this.factorialCache = {0: 1};
            }

            _factorial(n) {
                if (n in this.factorialCache) return this.factorialCache[n];
                if (n < 0) return NaN;
                if (n === 0) return 1;
                let result = 1;
                for (let i = 2; i <= n; i++) {
                    result *= i;
                }
                this.factorialCache[n] = result;
                return result;
            }

            _poissonProb(k, lam) {
                if (lam <= 0) {
                    return k === 0 ? 1.0 : 0.0;
                }
                return (Math.pow(lam, k) * Math.exp(-lam)) / this._factorial(k);
            }

            calculatePoissonProbabilities(matchData) {
                const homeAttackStrength = matchData.home_avg_score * (6 - matchData.away_difficulty) / 5;
                const awayAttackStrength = matchData.away_avg_score * (6 - matchData.home_difficulty) / 5;
                const homeDefenseStrength = matchData.home_avg_conceded * (matchData.away_difficulty / 5);
                const awayDefenseStrength = matchData.away_avg_conceded * (matchData.home_difficulty / 5);
                const homeExpectedGoals = (homeAttackStrength + awayDefenseStrength) / 2;
                const awayExpectedGoals = (awayAttackStrength + homeDefenseStrength) / 2;
                
                // *** UPDATED based on new_version.py ***
                const maxGoals = 4;
                let homeWin = 0, draw = 0, awayWin = 0;
                
                for (let h = 0; h <= maxGoals; h++) {
                    for (let a = 0; a <= maxGoals; a++) {
                        const probH = this._poissonProb(h, homeExpectedGoals);
                        const probA = this._poissonProb(a, awayExpectedGoals);
                        const cellProb = probH * probA;
                        if (h > a) homeWin += cellProb;
                        else if (h === a) draw += cellProb;
                        else awayWin += cellProb;
                    }
                }
                
                return {
                    home_win: homeWin,
                    draw: draw,
                    away_win: awayWin,
                    expected_goals: { home: homeExpectedGoals, away: awayExpectedGoals }
                };
            }

            calculateFormBasedPrediction(matchData) {
                let homeForm = matchData.home_score_percentage / 100.0;
                let awayForm = matchData.away_score_percentage / 100.0;
                const totalForm = homeForm + awayForm;
                let homeFormAdvantage = 0.5, awayFormAdvantage = 0.5;

                if (totalForm > 0) {
                    homeFormAdvantage = homeForm / totalForm;
                    awayFormAdvantage = awayForm / totalForm;
                }

                const homeAdvantageBoost = 0.07;
                homeFormAdvantage += homeAdvantageBoost;
                const formSum = homeFormAdvantage + awayFormAdvantage;
                homeFormAdvantage /= formSum;
                awayFormAdvantage /= formSum;

                const formDifference = Math.abs(homeFormAdvantage - awayFormAdvantage);
                let drawProb = 0.35 - (formDifference * 0.2);
                drawProb = Math.max(0.15, Math.min(0.45, drawProb));

                const remainingProb = 1.0 - drawProb;
                return { 
                    home_win: homeFormAdvantage * remainingProb, 
                    draw: drawProb, 
                    away_win: awayFormAdvantage * remainingProb 
                };
            }

            calculateDefensiveStrengthModel(matchData) {
                const homeDefenseRating = (matchData.home_cleansheet / 100.0) * (1 / Math.max(0.1, matchData.home_avg_conceded));
                const awayDefenseRating = (matchData.away_cleansheet / 100.0) * (1 / Math.max(0.1, matchData.away_avg_conceded));
                const homeAttackVsAwayDefense = matchData.home_avg_score / Math.max(0.1, matchData.away_avg_conceded);
                const awayAttackVsHomeDefense = matchData.away_avg_score / Math.max(0.1, matchData.home_avg_conceded);
                const totalAttackRatio = homeAttackVsAwayDefense + awayAttackVsHomeDefense;
                let homeAttackNorm = 0.5, awayAttackNorm = 0.5;

                if (totalAttackRatio > 0) {
                    homeAttackNorm = homeAttackVsAwayDefense / totalAttackRatio;
                    awayAttackNorm = awayAttackVsHomeDefense / totalAttackRatio;
                }

                const avgDefenseStrength = (homeDefenseRating + awayDefenseRating) / 2;
                const drawBoost = Math.min(0.15, avgDefenseStrength * 0.3);
                const baseDraw = 0.25 + drawBoost;
                const remainingProb = 1.0 - baseDraw;

                return { 
                    home_win: homeAttackNorm * remainingProb, 
                    draw: baseDraw, 
                    away_win: awayAttackNorm * remainingProb 
                };
            }

            calculateMarketSentimentModel(matchData) {
                const homeImplied = 1 / matchData.home_odds;
                const drawImplied = 1 / matchData.draw_odds;
                const awayImplied = 1 / matchData.away_odds;
                const totalImplied = homeImplied + drawImplied + awayImplied;

                return {
                    home_win: homeImplied / totalImplied,
                    draw: drawImplied / totalImplied,
                    away_win: awayImplied / totalImplied
                };
            }

            calculateCompositeRatingModel(matchData) {
                const homeQuality = (
                    matchData.home_avg_score * 0.3 +
                    (1 / Math.max(0.1, matchData.home_avg_conceded)) * 0.2 +
                    (matchData.home_score_percentage / 100) * 0.25 +
                    (matchData.home_cleansheet / 100) * 0.15 +
                    ((6 - matchData.home_difficulty) / 5) * 0.1
                );
                const awayQuality = (
                    matchData.away_avg_score * 0.3 +
                    (1 / Math.max(0.1, matchData.away_avg_conceded)) * 0.2 +
                    (matchData.away_score_percentage / 100) * 0.25 +
                    (matchData.away_cleansheet / 100) * 0.15 +
                    ((6 - matchData.away_difficulty) / 5) * 0.1
                );

                const qualityDiff = homeQuality - awayQuality;
                const homeBaseProb = 1 / (1 + Math.exp(-qualityDiff * 3));
                const awayBaseProb = 1 - homeBaseProb;
                const contextFactor = Math.sqrt(homeQuality * awayQuality);
                let drawProb = Math.min(0.4, 0.2 + (contextFactor * 0.15));
                const remaining = 1.0 - drawProb;

                return {
                    home_win: homeBaseProb * remaining,
                    draw: drawProb,
                    away_win: awayBaseProb * remaining,
                    home_quality: homeQuality,
                    away_quality: awayQuality
                };
            }

            predictMatch(matchData) {
                const models = {
                    poisson: this.calculatePoissonProbabilities(matchData),
                    form_based: this.calculateFormBasedPrediction(matchData),
                    defensive_strength: this.calculateDefensiveStrengthModel(matchData),
                    market_sentiment: this.calculateMarketSentimentModel(matchData),
                    composite_rating: this.calculateCompositeRatingModel(matchData)
                };

                let finalHome = 0, finalDraw = 0, finalAway = 0;
                for (const modelName in this.weights) {
                    finalHome += models[modelName]['home_win'] * this.weights[modelName];
                    finalDraw += models[modelName]['draw'] * this.weights[modelName];
                    finalAway += models[modelName]['away_win'] * this.weights[modelName];
                }

                const total = finalHome + finalDraw + finalAway;
                finalHome /= total;
                finalDraw /= total;
                finalAway /= total;

                const maxProb = Math.max(finalHome, finalDraw, finalAway);
                let predictedOutcome = "Away Win";
                if (maxProb === finalHome) predictedOutcome = "Home Win";
                else if (maxProb === finalDraw) predictedOutcome = "Draw";

                const probs = [finalHome, finalDraw, finalAway];
                const entropy = -probs.reduce((sum, p) => sum + p * Math.log(p + 1e-10), 0);
                const confidence = 1 - (entropy / Math.log(3));

                return {
                    predicted_outcome: predictedOutcome,
                    probabilities: { home_win: finalHome, draw: finalDraw, away_win: finalAway },
                    confidence: confidence,
                    expected_goals: models.poisson.expected_goals,
                    model_breakdown: models,
                    team_quality_scores: { home: models.composite_rating.home_quality, away: models.composite_rating.away_quality }
                };
            }
        }

        // *** UPDATED based on new_version.py ***
        function getWageringAdvice(prediction) {
            const finalProbs = prediction.probabilities;
            const poissonProbs = prediction.model_breakdown.poisson;
            const compositeProbs = prediction.model_breakdown.composite_rating;
            const formProbs = prediction.model_breakdown.form_based;
            const defenseProbs = prediction.model_breakdown.defensive_strength;
            const marketProbs = prediction.model_breakdown.market_sentiment;

            
            const hom_pie = poissonProbs.home_win - finalProbs.home_win;
            const awy_pie = poissonProbs.away_win - finalProbs.away_win;
            const hcon = poissonProbs.home_win - compositeProbs.home_win;
            const acon = poissonProbs.away_win - compositeProbs.away_win;
            const hhcon = marketProbs.home_win > marketProbs.away_win;
            const aacon = marketProbs.home_win < marketProbs.away_win;
            const fh = formProbs.home_win - defenseProbs.away_win;
            const fa = formProbs.away_win - defenseProbs.home_win;
            const hom = (fh * 100) + (compositeProbs.home_win * 100);
            const awy = (fa * 100) + (compositeProbs.away_win * 100);
            const hch = compositeProbs.home_win > defenseProbs.home_win;
            const ach = compositeProbs.away_win > defenseProbs.away_win;
            const h = defenseProbs.home_win;
            const a = defenseProbs.away_win;

            if (awy_pie < hom_pie && fh > fa && hcon > acon && h > a && hhcon) return 'H';
            if (awy_pie > hom_pie && fh < fa && hcon < acon && a > h && aacon) return 'A';
            if (hom > (finalProbs.home_win * 100) && awy < (finalProbs.away_win * 100) && hch) return '1X';
            if (hom < (finalProbs.home_win * 100) && awy > (finalProbs.away_win * 100) && ach) return '2X';
            
            return 'PASS';
        }

        document.getElementById('predictBtn').addEventListener('click', () => {
            const matchData = {
                home_avg_score: parseFloat(document.getElementById('home_avg_score').value),
                away_avg_score: parseFloat(document.getElementById('away_avg_score').value),
                home_avg_conceded: parseFloat(document.getElementById('home_avg_conceded').value),
                away_avg_conceded: parseFloat(document.getElementById('away_avg_conceded').value),
                home_score_percentage: parseFloat(document.getElementById('home_score_percentage').value),
                away_score_percentage: parseFloat(document.getElementById('away_score_percentage').value),
                home_cleansheet: parseFloat(document.getElementById('home_cleansheet').value),
                away_cleansheet: parseFloat(document.getElementById('away_cleansheet').value),
                home_difficulty: parseInt(document.getElementById('home_difficulty').value),
                away_difficulty: parseInt(document.getElementById('away_difficulty').value),
                home_odds: parseFloat(document.getElementById('home_odds').value),
                draw_odds: parseFloat(document.getElementById('draw_odds').value),
                away_odds: parseFloat(document.getElementById('away_odds').value)
            };
            
            for (const key in matchData) {
                if (isNaN(matchData[key])) {
                    alert(`Please enter a valid number for ${key.replace(/_/g, ' ')}.`);
                    return;
                }
            }

            const predictor = new FootballPredictor();
            const prediction = predictor.predictMatch(matchData);
            const advice = getWageringAdvice(prediction);
            
            const resultsSection = document.getElementById('results-section');
            resultsSection.classList.remove('hidden');

            const adviceDiv = document.getElementById('wagering-advice');
            adviceDiv.textContent = advice;
            adviceDiv.className = (advice === 'PASS') ? 'advice-pass' : 'advice-bet';

            document.getElementById('predicted-outcome').textContent = prediction.predicted_outcome;
            document.getElementById('confidence-level').textContent = (prediction.confidence * 100).toFixed(1) + '%';
            
            document.getElementById('final-prob-home').textContent = (prediction.probabilities.home_win * 100).toFixed(1) + '%';
            document.getElementById('final-prob-draw').textContent = (prediction.probabilities.draw * 100).toFixed(1) + '%';
            document.getElementById('final-prob-away').textContent = (prediction.probabilities.away_win * 100).toFixed(1) + '%';

            document.getElementById('expected-goals-home').textContent = prediction.expected_goals.home.toFixed(2);
            document.getElementById('expected-goals-away').textContent = prediction.expected_goals.away.toFixed(2);
            
            document.getElementById('quality-score-home').textContent = prediction.team_quality_scores.home.toFixed(3);
            document.getElementById('quality-score-away').textContent = prediction.team_quality_scores.away.toFixed(3);

            for(const modelName in prediction.model_breakdown) {
                const probs = prediction.model_breakdown[modelName];
                const cleanName = modelName.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                const breakdownEl = document.getElementById(`breakdown-${modelName}`);
                breakdownEl.innerHTML = `
                    <span class="model-name">${cleanName}</span>
                    <span class="model-probs">
                        H: ${(probs.home_win * 100).toFixed(1)}% | 
                        D: ${(probs.draw * 100).toFixed(1)}% | 
                        A: ${(probs.away_win * 100).toFixed(1)}%
                    </span>
                `;
            }
        });
    </script>
</body>
                        </html>
